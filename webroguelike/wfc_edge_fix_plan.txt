# WFC 맵 가장자리 타일 생성 오류 분석 및 해결 계획 (wfc_edge_fix_plan.txt)

## 1. 문제 정의
게임 실행 중 콘솔에 다음과 같은 경고 메시지가 반복적으로 발생하며, 맵이 제대로 로드되지 않거나 플레이어가 갇히는 문제가 발생할 수 있습니다.
- `No walkable tile found on the 'down' edge. Returning a random empty tile as fallback.`
- `No walkable tile found on the 'right' edge. Returning a random empty tile as fallback.`

이 경고는 `utils.js`의 `findWalkableTileOnEdge` 또는 `findSafeWalkableTileOnEdge` 함수에서 발생하며, 맵의 가장자리(출구/입구 예상 위치)에 이동 가능한(walkable) 타일을 찾지 못했음을 의미합니다. 결과적으로 fallback 로직에 따라 랜덤한 빈 타일을 반환하게 됩니다.

## 2. 원인 분석

### 2.1. WFC 맵 생성의 한계 및 `tiles.js` 구성
- **WFC 알고리즘 자체:** Wave Function Collapse는 패턴을 기반으로 맵을 생성합니다. 정의된 `ADJACENCY_RULES`가 너무 엄격하거나, 특정 타일(특히 `walkable` 타일)의 가중치가 낮으면, 맵 가장자리에 요구되는 `walkable` 타일 패턴을 생성하지 못할 수 있습니다.
- **`tiles.js`의 `ADJACENCY_RULES`:** 현재 `tiles.js`의 `ADJACENCY_RULES`는 각 타일의 인접 가능성을 정의합니다. 이 규칙들이 맵의 가장자리에서 `walkable` 타일이 생성되는 것을 어렵게 만들 수 있습니다. 예를 들어, 가장자리에 주로 생성되어야 할 `FIELD_BASE_NONE`과 같은 타일이 다른 `walkable` 타일과만 인접하도록 강제될 경우, 가장자리에 고립될 수 있습니다.
- **`tiles.js`의 `TILE_PROPERTIES` (가중치 누락):** `wfc.js`의 `buildTileWeights` 함수는 `baseWeight`와 `weightModifiers.multiplier`를 사용하도록 설계되었지만, 현재 `tiles.js`의 대부분의 `TILE_PROPERTIES`에는 이 속성들이 정의되어 있지 않습니다. 이로 인해 모든 타일이 기본 가중치 `1`을 가지게 되어, WFC가 `walkable` 타일을 선호하지 않고 무작위로 타일을 선택할 가능성이 높습니다. 특히 가장자리에 `walkable` 타일이 더 자주 생성되어야 할 필요가 있을 때 문제가 됩니다.

### 2.2. `utils.js`의 안전 스폰 로직
- **`findWalkableTileOnEdge`:** 이 함수는 단순히 가장자리에 `walkable` 속성을 가진 타일을 찾습니다. 실패 시 `getRandomEmptyTile`로 fallback 합니다.
- **`findSafeWalkableTileOnEdge`:** 이 함수는 `findWalkableTileOnEdge`가 찾은 타일이 `minReachableTiles` (기본값 30) 이상 도달 가능한지 `countReachableWalkableTiles`를 통해 확인합니다. 이는 플레이어가 맵의 작은 "섬"에 갇히는 것을 방지하기 위함입니다.
- **`minReachableTiles`의 적정성:** 맵의 전체 크기나 바이옴의 특성(예: 장애물이 많은 바이옴)에 비해 `minReachableTiles` 값이 너무 높게 설정되어 있을 경우, `walkable` 타일은 존재하지만 충분히 넓은 `walkable` 영역이 아니라는 이유로 안전 검사를 통과하지 못하고 fallback이 자주 발생할 수 있습니다.
- **`maxTries`의 부족:** 안전한 타일을 찾는 시도 횟수(`maxTries`, 기본값 40)가 부족하여, 여러 번 시도했음에도 불구하고 조건을 만족하는 타일을 찾지 못하고 결국 fallback이 발생할 수 있습니다.

## 3. 해결 방안

### 방안 1: `tiles.js`의 `TILE_PROPERTIES`에 가중치 정보 추가 (권장 및 시급)
현재 `tiles.js`와 `wfc.js`의 가장 큰 불일치 지점입니다. `wfc.js`는 가중치를 사용하도록 설계되었으나, `tiles.js`가 가중치 정보를 제공하지 않아 WFC가 타일 선택 시 가중치 이점을 활용하지 못하고 있습니다.
- **모든 바이옴의 `TILE_PROPERTIES` 내 `walkable` 타일에 `baseWeight` 추가:** 특히 `FIELD_BASE_NONE`과 같은 기본 필드 타일의 `baseWeight`를 높게 설정하여 WFC가 이를 더 자주 선택하도록 유도합니다.
- **오브젝트/비보행 가능 타일에 `baseWeight`를 낮게 설정하거나 `weightModifiers: { multiplier: X }` 적용:** `WOOD_X`, `ROCK`, `LAKE_X` 타일 등은 `baseWeight`를 낮게 설정하거나 `multiplier`를 적용하여 출현 빈도를 줄입니다.
- **예시 (Forest Biome):**
    ```javascript
    const FOREST_TILE_PROPERTIES = {
        [FOREST_TILE_TYPES.FIELD_BASE_NONE]: { walkable: true, spawnable: true, baseWeight: 12, path: '/img/FIELD_BASE_NONE.png' },
        [FOREST_TILE_TYPES.FIELD_BASE_FLOWER]: { walkable: true, spawnable: true, baseWeight: 4, path: '/img/forest/FIELD_BASE_FLOWER.png', drawTransparency: 0.25 },
        [FOREST_TILE_TYPES.FIELD_BASE_SEED]: { walkable: true, spawnable: true, baseWeight: 3, path: '/img/forest/FIELD_BASE_SEED.png', drawTransparency: 0.25 },
        [FOREST_TILE_TYPES.WOOD_1]: { walkable: false, spawnable: false, baseWeight: 2, path: '/img/forest/WOOD_1.png', weightModifiers: { multiplier: 0.5 } },
        // ...
        [FOREST_TILE_TYPES.LAKE_MM]: { walkable: false, spawnable: false, baseWeight: 0.5, path: '/img/forest/LAKE_MM.png' },
    };
    ```

### 방안 2: `tiles.js`의 `ADJACENCY_RULES` 조정 (세부 조정 필요)
맵 가장자리 타일 생성을 더 용이하게 하도록 규칙을 완화합니다.
- **기본 필드 타일의 인접 규칙 완화:** `FIELD_BASE_NONE`과 같은 기본 `walkable` 타일이 다양한 유형의 타일(다른 `walkable` 타일, 일부 장애물)과 인접할 수 있도록 규칙을 더 유연하게 만듭니다.
- **맵 가장자리에 생성될 타일의 규칙 명시:** 특정 `walkable` 타일이 맵 가장자리에서 생성되는 것을 선호하도록 규칙을 조정합니다.
- **`FOREST_ADJACENCY_RULES`의 `LAKE_MM` 규칙 수정:** `LAKE_MM`은 다른 호수 타일(예: `LAKE_UM`, `LAKE_ML` 등)과도 인접할 수 있도록 규칙을 확장하여 호수 패턴이 제대로 형성되도록 합니다.
    ```javascript
    [FOREST_TILE_TYPES.LAKE_MM]: {
        up: [FOREST_TILE_TYPES.LAKE_MM, FOREST_TILE_TYPES.LAKE_UM, FOREST_TILE_TYPES.LAKE_DL, FOREST_TILE_TYPES.LAKE_DR], // 예시: 다른 호수 타일도 포함
        // ... 다른 방향도 유사하게 수정
    },
    ```
- **모든 바이옴의 `WOOD` 타일 인접 규칙 추가:** 현재 `ICE`, `CAVE`, `VOLCANO` 바이옴의 `WOOD` 타일에는 인접 규칙이 없습니다. 이 타일들이 `walkable` 타일, 특히 해당 바이옴의 기본 `FLOOR` 타일에 인접할 수 있도록 규칙을 추가해야 합니다.
    ```javascript
    // 예시: ICE_WOOD_1
    [ICE_TILE_TYPES.ICE_WOOD_1]: {
        up: ICE_FLOOR_TILES, // 기본 바닥 타일에 인접
        right: ICE_FLOOR_TILES,
        down: ICE_FLOOR_TILES,
        left: ICE_FLOOR_TILES,
    },
    ```
    이전에 `ICE_OBSTACLE_TILES`, `CAVE_OBSTACLE_TILES`, `VOLCANO_OBSTACLE_TILES`에 대한 규칙은 있었으나, 개별 `WOOD_X` 타일에 대한 구체적인 규칙이 누락되었을 가능성도 검토해야 합니다.

### 방안 3: `utils.js`의 `findSafeWalkableTileOnEdge` 값 조정
- `minReachableTiles` 감소: 맵 크기나 맵 생성 패턴이 작은 연결 영역을 자주 생성하는 경우, `minReachableTiles` 값을 줄여서 안전 타일로 간주되는 기준을 낮춥니다. (예: 30 -> 15 또는 20)
- `maxTries` 증가: 안전한 타일을 찾기 위한 시도 횟수(`maxTries`)를 늘려, 실패할 확률을 줄입니다. (예: 40 -> 80 또는 100)

### 방안 4: `wfc.js`의 맵 생성 시도 횟수 증가
- `generateWfcMap` 함수의 `tries` 변수 (현재 기본값 10)를 늘려, WFC가 유효한 맵을 생성하기 위한 전체 시도 횟수를 늘립니다. (예: 10 -> 20 또는 30)

## 4. 권장 진행 순서

1.  **방안 1 (`tiles.js` 가중치 정보 추가)을 가장 먼저 적용합니다.** 이는 `wfc.js`가 의도대로 작동하게 하는 기본이며, 맵 구성의 전반적인 균형을 잡는 데 필수적입니다.
2.  **방안 2 (`tiles.js` `ADJACENCY_RULES` 수정) 중 `WOOD` 타일 규칙 누락 부분을 먼저 추가합니다.**
3.  **애플리케이션을 실행하여 맵 생성 결과를 확인합니다.** 가중치와 인접 규칙 변경만으로 문제가 해결될 수 있습니다.
4.  여전히 문제가 발생한다면, **`LAKE_MM` 규칙을 조정**하고 **`utils.js`의 `minReachableTiles` 및 `maxTries` 값을 조정**합니다.

이 계획에 대해 어떻게 생각하시나요? 어떤 방안부터 진행할지 알려주시면 그에 따라 코드를 수정하겠습니다.