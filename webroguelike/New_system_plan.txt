# [통합 제안] 살아있는 세계 시스템 (Living World System)

## 1. 시스템 개요
플레이어의 레벨 성장에 따른 자연스러운 몬스터 분포 변화와, 플레이어의 행동이 던전 생태계에 직접적인 영향을 미치는 '살아있는 던전' 시스템을 결합한 통합 시스템입니다. 이를 통해 플레이어는 자신의 성장을 체감하는 동시에, 자신의 행동이 세상에 의미 있는 변화를 만들어내는 것을 경험하게 됩니다.

## 2. 핵심 컨셉
- **성장과 변화의 조화:** 플레이어의 레벨은 몬스터의 기본적인 강함과 종류(Stage)를 결정합니다. 플레이어의 행동은 해당 Stage 내에서 몬스터의 세력 분포, 등장 빈도 등(Ecology)을 변화시킵니다.
- **예측 가능성과 불확실성의 공존:** 플레이어는 자신의 레벨에 맞는 몬스터 등장을 예측할 수 있지만, 과거 자신의 행동이 누적된 생태계 변화로 인해 예상치 못한 몬스터 조합이나 이벤트를 마주하게 됩니다.
- **의미 있는 상호작용:** 몬스터 사냥, 스킬 사용, 아이템 획득 등 플레이어의 모든 행동은 단기적인 보상뿐만 아니라, 던전 세계에 장기적인 흔적을 남기는 의미 있는 행위가 됩니다.

## 3. 통합 구현 아이디어

### 3.1. 몬스터 스폰 로직 (맵 생성 시)
1.  **1단계: 레벨에 따른 '기본 몬스터 풀' 결정**
    -   플레이어의 현재 레벨을 기준으로 해당 지역에 등장할 수 있는 몬스터의 목록과 기본 등장 확률을 결정합니다.
    -   **예시:**
        -   Lv. 1~5: `[슬라임: 50%, 고블린: 40%, 스켈레톤: 10%]`
        -   Lv. 6~10: `[고블린: 30%, 오크: 30%, 코볼트: 20%, 슬라임: 10%, 스켈레톤: 10%]`

2.  **2단계: '던전 상태(Dungeon State)'에 따른 '생태계 보정' 적용**
    -   `dungeonState.js`에 저장된 전역 변수(`monsterPopulation`, `environmentState` 등)를 참조하여 기본 몬스터 풀의 등장 확률을 실시간으로 보정합니다.
    -   **예시:**
        -   만약 플레이어가 '고블린'을 집중적으로 사냥하여 `monsterPopulation.goblin` 수치가 50% 이하로 떨어졌다면:
            -   고블린의 등장 확률을 기본값(30%)에서 15%로 감소시킵니다.
            -   고블린의 천적인 '오크'의 등장 확률도 소폭(30% -> 25%) 감소시킵니다. (먹이 감소)
            -   고블린의 경쟁자인 '코볼트'의 등장 확률은 대폭(20% -> 40%) 증가시킵니다. (경쟁자 부재)
        -   플레이어가 '화염' 속성 스킬을 난사하여 `environmentState.global_temperature`가 특정 수치 이상으로 올랐다면:
            -   '아이스 골렘'과 같은 냉기 몬스터의 등장 확률이 감소하고, '파이어 스네이크' 같은 화염 몬스터가 대신 등장할 수 있습니다.

3.  **3단계: 최종 몬스터 결정 및 스폰**
    -   위의 과정을 거쳐 최종적으로 보정된 확률에 따라 맵에 스폰할 몬스터를 결정합니다.

### 3.2. 상태 관리 및 규칙 엔진 (신규 파일: `dungeonState.js`, `effectRules.js`)
-   기존 '살아있는 던전' 시스템의 제안대로, 플레이어의 행동을 기록하고 그에 따른 세계의 변화를 처리할 `dungeonState.js`와 `effectRules.js`를 도입합니다.
-   **추가 규칙:**
    -   `PLAYER_LEVEL_UP` 액션: 플레이어가 레벨 업 할 때마다, 특정 상위 몬스터의 기본 `monsterPopulation` 수치가 소폭 증가하여 전반적인 월드 난이도가 서서히 상승하는 효과를 줄 수 있습니다.
    -   `BOSS_KILLED` 액션: 특정 보스(예: '고블린 킹')를 처치하면, 해당 종족 전체의 `monsterPopulation`이 영구적으로 일정 비율 감소하고, 다른 종족이 그 영역을 차지하려는 시나리오로 이어질 수 있습니다.

### 3.3. 특수 몬스터 및 이벤트 등장 조건
-   단순히 레벨이 높다고 등장하는 것이 아니라, '레벨'과 '던전 상태' 조건이 모두 충족되었을 때 등장합니다.
-   **예시: '킹 슬라임'의 등장**
    -   **조건 1 (레벨):** 플레이어 레벨 10 이상.
    -   **조건 2 (생태계):** 플레이어가 '슬라임'을 500마리 이상 사냥하여 `monsterPopulation.slime` 수치가 극도로 낮아짐.
    -   **결과:** 위 두 조건이 충족된 상태에서 플레이어가 '초원' 지역에 진입 시, '복수' 이벤트와 함께 '킹 슬라임'이 보스로 등장합니다.

## 4. 기대 효과
-   플레이어는 레벨을 올리며 더 강한 몬스터와 싸우는 전통적인 RPG의 재미를 느낄 수 있습니다.
-   동시에, 자신의 행동이 만들어낸 독특한 몬스터 분포와 예상치 못한 이벤트들을 통해 매번 새로운 탐험의 재미를 경험할 수 있습니다.
-   "왜 이번엔 유독 코볼트만 나올까?" 와 같은 의문을 통해 플레이어는 자신이 과거에 했던 행동을 되짚어보게 되고, 게임 세계에 더 깊이 몰입하게 됩니다.

---

# "살아있는 세계 시스템" 구현 계획

**과업:** 플레이어의 레벨과 행동이 몬스터 생태계에 동적으로 영향을 미치는 "살아있는 세계 시스템"을 구현합니다.

**담당:** `developer`

---

## [1단계] 기본 상태 관리 시스템 구축
-   **제목:** `dungeonState.js` 파일 생성 및 상태 변수 정의
-   **세부사항:**
    1.  `src/main/resources/static/js/` 경로에 `dungeonState.js` 파일을 새로 생성합니다.
    2.  이 파일에 `monsterPopulation`, `environmentState`, `eventFlags` 등을 포함하는 `dungeonState` 객체를 정의합니다.
    3.  `localStorage`를 사용하여 게임 세션 간 상태를 저장하고(`saveDungeonState`) 불러오는(`loadDungeonState`) 함수를 구현합니다.

---

## [2단계] 원인-결과 규칙 엔진 구현
-   **제목:** `effectRules.js` 파일 생성 및 행동 규칙 정의
-   **세부사항:**
    1.  `src/main/resources/static/js/` 경로에 `effectRules.js` 파일을 새로 생성합니다.
    2.  플레이어의 행동(`KILL_MONSTER`, `USE_SKILL` 등)을 받아 `dungeonState`를 수정하는 `applyActionEffect(action, state)` 함수를 구현합니다.
    3.  몬스터 사냥 시 개체 수 감소, 특정 스킬 사용 시 환경 변수 변화 등의 규칙을 코드로 작성합니다.

---

## [3단계] 게임 로직에 규칙 엔진 연동
-   **제목:** `gameLogic.js`를 수정하여 플레이어 행동 기록
-   **세부사항:**
    1.  `gameLogic.js` 파일 내에서 몬스터가 죽거나 플레이어가 스킬을 사용하는 부분의 코드를 수정합니다.
    2.  해당 이벤트가 발생할 때, 2단계에서 만든 `applyActionEffect` 함수를 호출하여 `dungeonState`가 실시간으로 업데이트되도록 연동합니다.
    3.  (예: `monster.die()` 함수 내에서 `applyActionEffect({type: 'KILL_MONSTER', monsterType: monster.type}, dungeonState)`를 호출)

---

## [4단계] 몬스터 스폰 로직 개편
-   **제목:** `map.js`의 몬스터 생성 로직 수정
-   **세부사항:**
    1.  `map.js`의 맵 생성 또는 몬스터 배치 관련 함수를 수정합니다.
    2.  **1)** 플레이어 레벨에 따라 기본 몬스터 풀을 결정하고, **2)** `dungeonState`를 참조하여 '생태계 보정'을 적용한 뒤, **3)** 최종적으로 계산된 확률에 따라 맵에 몬스터를 생성하도록 로직을 변경합니다.

---

## [5단계] 시스템 동작 확인 및 UI 피드백 추가
-   **제목:** 디버깅 UI 및 정보창 추가
-   **세부사항:**
    1.  시스템이 의도대로 작동하는지 쉽게 확인하기 위해, 현재 `dungeonState`의 주요 상태(예: 몬스터 개체 수)를 게임 화면에 표시하는 간단한 디버그 UI를 추가합니다.
    2.  (선택 사항) 마을의 NPC나 특정 메뉴를 통해 현재 던전 생태계에 대한 힌트("최근 고블린의 수가 줄어든 것 같네...")를 얻을 수 있는 정보창 기능을 구현하여 플레이어 피드백을 강화합니다.

---

# 5. 고도화 방안 (Advanced Enhancement Plan)

기존 "살아있는 세계 시스템"의 개념을 프로젝트의 바이옴 특성과 몬스터 다양성에 맞춰 더욱 유기적이고 깊이 있는 경험을 제공하기 위한 추가적인 고도화 방안을 제안합니다.

## 5.1. 바이옴별 환경 상태 및 영향력 시스템 도입

-   **현황:** 현재 `dungeonState.environmentState`는 `global_temperature`와 같은 전역 변수에 의존하여 모든 바이옴에 일괄적으로 영향을 미칩니다. 이는 바이옴별 특성을 반영하기 어렵습니다.
-   **개선 방안:**
    -   `dungeonState.environmentState` 구조를 개편하여 각 바이옴(FOREST, ICE, CAVE, VOLCANO)별로 독립적인 환경 변수(예: `temperature`, `humidity`, `magicalEnergy`, `pollutionLevel` 등)를 관리합니다.
        ```javascript
        // dungeonState.js (예시)
        environmentState: {
            FOREST: { temperature: 15.0, humidity: 0.7, magicalEnergy: 0.3 },
            ICE: { temperature: -10.0, humidity: 0.2, magicalEnergy: 0.5 },
            // ... 기타 바이옴
        }
        ```
    -   **플레이어 행동의 지역화:** 플레이어의 특정 스킬 사용(예: 화염구)은 이제 해당 플레이어가 위치한 바이옴의 `temperature`나 `magicalEnergy`에 국지적으로 영향을 미칩니다. (예: 숲에서 화염 스킬을 자주 사용하면 숲 바이옴의 온도가 상승)
    -   **스폰 로직의 강화:** `generateMonster` 함수는 몬스터 스폰 시 `gameState.currentBiome`에 해당하는 `dungeonState.environmentState`를 참조하여 몬스터의 등장 가중치를 더욱 정교하게 조절합니다.
        -   예: 화염 속성 몬스터는 해당 바이옴의 `temperature`가 높을수록 가중치 크게 증가. 얼음 속성 몬스터는 `temperature`가 낮을수록 증가. 오염된 바이옴에서는 독 속성 몬스터 증가 등.
        -   `MONSTER_TYPES` 정의에 `elementalType`이나 `environmentalPreference` 속성을 추가하여 활용도를 높입니다.

## 5.2. 다이나믹 보스/특수 이벤트 몬스터 등장 메커니즘

-   **현황:** 보스 몬스터 등장 조건이 단편적(레벨, 특정 몬스터 사냥 수)입니다.
-   **개선 방안:** `dungeonState.eventFlags`를 활용하여 복합적인 조건과 시간의 흐름을 고려한 보스 및 특수 이벤트 몬스터 등장 로직을 구축합니다.
    -   **몬스터 생태계 변화 추적:** 특정 몬스터 유형의 개체 수가 비정상적으로 감소하거나 증가할 경우, 해당 몬스터의 '수호자' 또는 '천적 보스'가 등장할 가능성을 높입니다.
        -   예: 고블린(`goblin`) 개체 수가 장기간 최저점을 유지할 경우 `eventFlags.goblinKingEnraged: true` 설정.
        -   거미(`spider`) 개체 수가 급감하고 곤충(`insect` - 신규 몬스터 타입 고려) 개체 수가 폭증할 경우 `eventFlags.spiderQueenAwakens: true` 설정.
    -   **환경 변화에 따른 보스:** 특정 바이옴의 환경 변수(예: `VOLCANO.magicalEnergy`가 극도로 높아지면)에 따라 해당 바이옴에 특화된 보스(예: `LavaLord`)가 등장할 수 있습니다.
    -   `generateMonster` 함수는 몬스터 풀을 구성하기 전에 `eventFlags`를 최우선으로 검사하여, 활성화된 보스 플래그가 있다면 해당 보스 몬스터를 강제로 스폰 목록에 포함하거나 높은 가중치를 부여합니다.

## 5.3. 모든 몬스터에 대한 생태계 상호작용 규칙 확장

-   **현황:** `effectRules.js`의 `KILL_MONSTER` 규칙은 현재 '고블린'에 대해서만 구체적으로 정의되어 있습니다. 40여 종의 몬스터에 대한 유기적인 생태계 규칙이 부족합니다.
-   **개선 방안:** `MONSTER_TYPES` 정의에 각 몬스터의 생태적 특성(프레데터/프레이 관계, 경쟁자, 서식지 선호도 등)을 명시하고, `effectRules.js`의 `handleKillMonster` 함수가 이를 동적으로 참조하여 다른 몬스터 개체 수에 영향을 미치도록 합니다.
    ```javascript
    // constants.js MONSTER_TYPES (예시)
    {
        name: "GOBLIN", archetype: 'standard', biomes: ['FOREST', 'CAVE'], skills: ["leapAttack", "venomousBite"],
        ecology: {
            prey: ['forest_animal_small', 'cave_insect'], // 고블린이 사냥하는 대상 (사냥 시 해당 개체수 감소)
            predators: ['GREY_WOLF', 'ORC_WARRIOR'], // 고블린의 천적 (천적 사냥 시 고블린 개체수 증가)
            competitors: ['KOBOLT'], // 고블린의 경쟁자 (경쟁자 사냥 시 고블린 개체수 증가)
            environmentalPreference: { temperature: 'moderate', humidity: 'normal' }
        }
    },
    {
        name: "GREY_WOLF", archetype: 'rusher', biomes: ['FOREST'], skills: ["charge", "venomousBite"],
        ecology: {
            prey: ['GOBLIN', 'forest_animal_small'],
            competitors: ['WEREWOLF'],
            // ...
        }
    }
    ```
-   `handleKillMonster`는 사냥된 몬스터의 `ecology` 정보를 바탕으로, `state.monsterPopulation`에서 연관된 다른 몬스터들의 개체 수를 동적으로 증감시킵니다. 이로써 모든 몬스터가 생태계의 한 축을 담당하며 유기적인 변화를 만들어냅니다.

## 5.4. 장기적인 바이옴 진화 및 변형 (맵 생성 로직 연동)

-   **현황:** `map.js`의 맵 생성 로직은 `dungeonState`를 참조하지만, 장기적인 환경 변화에 따른 바이옴 자체의 `지형적` 변화는 구현되어 있지 않습니다.
-   **개선 방안:** `dungeonState.environmentState`에 기록된 각 바이옴의 장기적인 환경 변화(예: `FOREST.temperature`가 장기간 높게 유지되면 `scorched_forest` 상태로 진입)가 `map.js`의 맵 생성에 영향을 미치도록 합니다.
    -   **새로운 타일셋/맵 테마 도입:** 예를 들어, `FOREST` 바이옴이 `scorched_forest` 상태가 되면, 맵 생성 시 `forestTiles` 대신 `scorchedForestTiles` (새로운 타일셋)을 사용하도록 합니다.
    -   **지형적 특징 변화:** 맵에 용암 지대, 독성 늪지, 얼음 균열 등이 더 자주/적게 나타나도록 합니다.

이러한 고도화 방안을 통해 "살아있는 세계 시스템"은 단순히 몬스터 스폰에 영향을 주는 것을 넘어, 플레이어의 행동 하나하나가 던전 전체의 모습과 난이도, 그리고 보스 등장 여부에까지 영향을 미치는 더욱 풍부하고 예측 불가능한 경험을 제공할 수 있을 것입니다.
